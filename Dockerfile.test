# Dockerfile Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
# Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Dockerfile Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

FROM python:3.11-slim

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Poetry
RUN pip install poetry

# ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ Python Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ)
RUN poetry config virtualenvs.create false

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
COPY pyproject.toml README.md ./

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð±ÐµÐ· ÑÐ°Ð¼Ð¾Ð³Ð¾ Ð¿Ð°ÐºÐµÑ‚Ð°)
RUN poetry install --no-interaction --no-ansi --no-root

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
COPY . .

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
RUN poetry install --no-interaction --no-ansi --only-root

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
RUN mkdir -p /app/data/chroma /app/data/uploads /app/test-results /app/htmlcov

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
ENV PYTHONPATH=/app
ENV ENVIRONMENT=test
ENV DEBUG=true

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
RUN echo '#!/bin/bash\n\
if [ "$1" = "test" ]; then\n\
    echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²..."\n\
    pytest "${@:2}"\n\
elif [ "$1" = "test-watch" ]; then\n\
    echo "ðŸ‘€ Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ..."\n\
    pytest-watch "${@:2}"\n\
elif [ "$1" = "coverage" ]; then\n\
    echo "ðŸ“Š Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼..."\n\
    pytest --cov=src --cov-report=html --cov-report=term "${@:2}"\n\
elif [ "$1" = "lint" ]; then\n\
    echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°..."\n\
    black --check src/ tests/ || echo "âŒ Black check failed"\n\
    isort --check-only src/ tests/ || echo "âŒ isort check failed"\n\
    flake8 src/ tests/ || echo "âŒ flake8 check failed"\n\
elif [ "$1" = "format" ]; then\n\
    echo "âœ¨ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."\n\
    black src/ tests/\n\
    isort src/ tests/\n\
elif [ "$1" = "shell" ]; then\n\
    echo "ðŸš Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð¾Ð±Ð¾Ð»Ð¾Ñ‡ÐºÐ°..."\n\
    /bin/bash\n\
else\n\
    echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."\n\
    exec "$@"\n\
fi' > /app/entrypoint-test.sh && chmod +x /app/entrypoint-test.sh

ENTRYPOINT ["/app/entrypoint-test.sh"]
CMD ["python", "-m", "src.main"]
