# Руководство по управлению моделью эмбеддингов

## Обзор

Начиная с версии, включающей этот функционал, модель эмбеддингов `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2` **не загружается автоматически** при сборке Docker образа. Вместо этого реализована система ручного управления моделью через веб-интерфейс.

## Зачем это нужно?

1. **Гибкость**: Можно контролировать когда и как загружается модель
2. **Надёжность**: Избежание таймаутов при сборке образа или индексации
3. **Прозрачность**: Полный контроль и мониторинг процесса загрузки
4. **Обновления**: Возможность перезагрузить модель при необходимости

## Как работает

### 1. Доступ к управлению

1. Войдите в админ-панель под учётной записью **администратора**
2. В боковом меню раздела "Каталог" найдите пункт "Модель эмбеддингов"
3. Перейдите на страницу управления моделью

**Важно**: Страница управления моделью доступна **только администраторам**. Менеджеры её не видят.

### 2. Страница управления

На странице отображается:

- **Провайдер**: `sentence-transformers`
- **Модель**: `paraphrase-multilingual-MiniLM-L12-v2`
- **Статус**: Загружена / Не загружена
- **Размер**: ~350 MB (после загрузки)
- **Прогресс загрузки** (если идёт процесс)

### 3. Первая загрузка модели

**Последовательность действий:**

1. Нажмите кнопку **"Скачать модель"**
2. Подтвердите действие в диалоге
3. Начнётся загрузка модели (~5-10 минут в зависимости от скорости интернета)
4. На странице появится индикатор прогресса:
   - 0-10%: Подготовка
   - 10-90%: Загрузка модели из HuggingFace
   - 90-100%: Проверка модели
5. После завершения статус изменится на "Загружена"

**Примечание**: Процесс загрузки выполняется в фоновом режиме. Вы можете закрыть страницу и вернуться позже.

### 4. Мониторинг загрузки

Для проверки текущего статуса:

- **Через веб-интерфейс**: Нажмите кнопку "Обновить статус" или просто обновите страницу
- **Через API**: `GET /admin/model/status` вернёт JSON с детальной информацией

### 5. Отмена загрузки

Если загрузка зависла или нужно прервать процесс:

1. Нажмите кнопку **"Отменить"** (появляется во время загрузки)
2. Статус сбросится
3. Можно повторить попытку загрузки

**Важно**: Физически остановить сетевую загрузку невозможно, но сброс статуса позволяет начать новую попытку.

### 6. Переза грузка модели

Если нужно обновить модель или что-то пошло не так:

1. Нажмите кнопку **"Перезагрузить"**
2. Подтвердите действие
3. Модель загрузится заново

Существующий кэш будет перезаписан.

### 7. Удаление модели

Для освобождения места на диске (~350 MB):

1. Нажмите кнопку **"Удалить модель"**
2. Прочитайте предупреждение в модальном окне
3. Подтвердите удаление

**Важно**: После удаления индексация каталога будет невозможна до повторной загрузки модели.

## Интеграция с загрузкой каталога

### Проверка перед загрузкой

Страница **"Загрузка каталога"** автоматически проверяет наличие модели:

- **Модель загружена**: Кнопка "Загрузить каталог" активна
- **Модель НЕ загружена**: 
  - Появляется предупреждение
  - Кнопка загрузки **заблокирована**
  - Есть ссылка для перехода к загрузке модели (для администраторов)

### Попытка загрузки без модели

Если кто-то попытается обойти проверку (например, через API):

```json
{
  "detail": "Модель эмбеддингов не загружена. Перейдите в раздел 'Модель эмбеддингов' для её загрузки."
}
```

Индексация не начнётся.

## Технические детали

### Расположение кэша

Модель кэшируется в контейнере по пути:
```
/root/.cache/huggingface/models--sentence-transformers--paraphrase-multilingual-MiniLM-L12-v2/
```

**Примечание:** Используется стандартный кэш HuggingFace (не hub/, не torch/sentence_transformers).

### Проверка через командную строку

Используйте скрипт для проверки статуса модели на сервере:

```bash
bash scripts/check_model.sh
```

Или вручную:

```bash
# Проверка директории
docker compose -f docker-compose.prod.yml exec app \
  ls -lh /root/.cache/huggingface/

# Проверка размера модели
docker compose -f docker-compose.prod.yml exec app \
  du -sh /root/.cache/huggingface/models--sentence-transformers--paraphrase-multilingual-MiniLM-L12-v2

# Проверка через Python API
docker compose -f docker-compose.prod.yml exec app python -c "
from pathlib import Path
cache_dir = Path.home() / '.cache' / 'huggingface'
model_name = 'models--sentence-transformers--paraphrase-multilingual-MiniLM-L12-v2'
model_dir = cache_dir / model_name

if model_dir.exists() and any(model_dir.iterdir()):
    print('✅ Модель загружена')
else:
    print('❌ Модель не загружена')
"
```

### API Endpoints

#### Получение статуса
```http
GET /admin/model/status
Authorization: Bearer <token>
```

**Ответ:**
```json
{
  "model_name": "sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2",
  "model_provider": "sentence-transformers",
  "model_exists": true,
  "model_size_bytes": 367001234,
  "model_size_mb": 349.92,
  "cache_path": "/root/.cache/torch/sentence_transformers",
  "is_downloading": false,
  "download_progress": 100,
  "download_message": "Модель успешно загружена и готова к использованию!",
  "download_error": null
}
```

#### Запуск загрузки
```http
POST /admin/model/download
Authorization: Bearer <token>
```

#### Отмена загрузки
```http
POST /admin/model/cancel
Authorization: Bearer <token>
```

#### Удаление модели
```http
DELETE /admin/model/
Authorization: Bearer <token>
```

## Решение проблем

### Загрузка зависла на 10-90%

**Причина**: Проблемы с доступом к HuggingFace Hub или медленный интернет

**Решение**:
1. Нажмите "Отменить"
2. Подождите 1-2 минуты
3. Попробуйте снова
4. Если проблема повторяется - проверьте доступность huggingface.co с сервера

### Модель не работает после загрузки

**Проверка**:
```bash
docker compose -f docker-compose.prod.yml exec app python -c "
from sentence_transformers import SentenceTransformer
model = SentenceTransformer('sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2')
embedding = model.encode(['тест'])
print('✅ Модель работает' if len(embedding) > 0 else '❌ Модель не работает')
"
```

**Решение**: Удалите и перезагрузите модель через интерфейс

### Ошибка при индексации несмотря на загруженную модель

**Проверка**:
1. Убедитесь что модель действительно загружена через `/admin/model/status`
2. Проверьте логи индексации: `docker compose -f docker-compose.prod.yml logs app --tail=100`

**Решение**: Перезапустите приложение:
```bash
docker compose -f docker-compose.prod.yml restart app
```

### Недостаточно места на диске

Модель занимает ~350 MB. Проверьте место:
```bash
df -h
```

Если место критично - удалите старые версии каталога через веб-интерфейс.

## Миграция с предыдущих версий

### Если модель УЖЕ была загружена автоматически

После обновления модель **останется в кэше** и будет работать. Страница управления покажет её как "Загружена".

### Если модель НЕ была загружена

После обновления:
1. Зайдите в раздел "Модель эмбеддингов"
2. Загрузите модель через интерфейс
3. После завершения загрузки можете загружать каталог

## Рекомендации

1. **Загружайте модель СРАЗУ** после деплоя на новом сервере
2. **Не удаляйте модель** без необходимости - переза грузка займёт время
3. **Мониторьте статус** через API при автоматизации
4. **Сохраняйте кэш** при обновлении приложения (он находится в `/root/.cache/`)

## Автоматизация

### Загрузка модели при деплое

Добавьте в скрипт деплоя:

```bash
# Проверка и загрузка модели
echo "Проверка модели эмбеддингов..."
MODEL_STATUS=$(docker compose -f docker-compose.prod.yml exec -T app python -c "
from pathlib import Path
cache_dir = Path.home() / '.cache' / 'torch' / 'sentence_transformers'
model_name = 'sentence-transformers_paraphrase-multilingual-MiniLM-L12-v2'
print('OK' if (cache_dir / model_name).exists() else 'MISSING')
" 2>/dev/null)

if [ "$MODEL_STATUS" = "MISSING" ]; then
    echo "Модель не найдена. Загрузка через API..."
    curl -X POST http://localhost:8000/admin/model/download \
      -H "Authorization: Bearer $ADMIN_TOKEN"
    
    echo "Ожидание завершения загрузки..."
    while true; do
        sleep 10
        STATUS=$(curl -s http://localhost:8000/admin/model/status \
          -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.download_progress')
        
        if [ "$STATUS" = "100" ]; then
            echo "✅ Модель загружена"
            break
        fi
    done
else
    echo "✅ Модель уже загружена"
fi
```

---

**Версия документа**: 1.0  
**Дата**: 20.10.2025  
**Применимо к**: llm-rag-bot v2.0+

