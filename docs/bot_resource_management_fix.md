# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ç–µ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ Bot

**–î–∞—Ç–∞:** 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –£—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `Bot` –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏

---

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. `lead_handlers.py` (—Å—Ç—Ä–æ–∫–∞ 819)
```python
# ‚ùå –î–û: –°–æ–∑–¥–∞–≤–∞–ª—Å—è Bot –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏
bot = Bot(token=settings.bot_token)
notifier = get_telegram_notifier(bot)
success = await notifier.notify_new_lead(lead, chat_id)
# –°–µ—Å—Å–∏—è bot –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∞—Å—å ‚Üí —É—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
```

### 2. `cost_alert_service.py` (—Å—Ç—Ä–æ–∫–∞ 184)
```python
# ‚ùå –î–û: Bot —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ö—Ä–∞–Ω–∏–ª—Å—è –≤ _bot
async def _get_bot(self):
    if self._bot is None:
        self._bot = Bot(token=self.settings.bot_token)
    return self._bot
# –°–µ—Å—Å–∏—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∞—Å—å ‚Üí —É—Ç–µ—á–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

### –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å: `src/infrastructure/utils/bot_utils.py`

```python
from contextlib import asynccontextmanager
from aiogram import Bot
from src.config.settings import settings

@asynccontextmanager
async def get_bot_for_notifications():
    """
    –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Bot –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
    """
    if not settings.bot_token:
        raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö")
    
    bot = Bot(token=settings.bot_token)
    try:
        yield bot
    finally:
        await bot.session.close()  # ‚úÖ –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```

---

## üìù –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. `lead_handlers.py`

```python
# ‚úÖ –ü–û–°–õ–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
from src.infrastructure.utils.bot_utils import get_bot_for_notifications

async with get_bot_for_notifications() as bot:
    notifier = get_telegram_notifier(bot)
    success = await notifier.notify_new_lead(lead, chat_id)
# –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞ with
```

### 2. `cost_alert_service.py`

```python
# ‚úÖ –ü–û–°–õ–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
from src.infrastructure.utils.bot_utils import get_bot_for_notifications

async with get_bot_for_notifications() as bot:
    for admin_id in admin_ids:
        await bot.send_message(chat_id=admin_id, text=message)
# –°–µ—Å—Å–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

# –£–¥–∞–ª–µ–Ω–æ:
# - self._bot = None –∏–∑ __init__
# - –º–µ—Ç–æ–¥ _get_bot() –ø–æ–ª–Ω–æ—Å—Ç—å—é
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤** - –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö
2. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å** - –æ–¥–∏–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—Ç
3. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Python best practices** - context managers
4. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - —è–≤–Ω–æ –≤–∏–¥–Ω–∞ –æ–±–ª–∞—Å—Ç—å –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞
5. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Clean Architecture** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

–í—Å–µ –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è `Bot` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:
- ‚úÖ `lead_handlers.py` - –º–µ—Ç–æ–¥ `_notify_managers()`
- ‚úÖ `cost_alert_service.py` - –º–µ—Ç–æ–¥ `_send_to_admins()`
- ‚ÑπÔ∏è `bot.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `lifespan` –≤ `main.py`

---

## üìö –°—Å—ã–ª–∫–∏

- –ü—Ä–∏–Ω—Ü–∏–ø –∏–∑ `@conventions.md` - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∏–∑ `@README.md` - 99.5% –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (—É—Ç–µ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–Ω–∏–∂–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
- Python Context Managers: https://docs.python.org/3/library/contextlib.html

---

*–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫—É HTTP —Å–µ—Å—Å–∏–π aiogram Bot, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.*

