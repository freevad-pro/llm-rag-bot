# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic –≤ Docker

## 1. –û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ (–æ—à–∏–±–∫–∏)

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤–æ–∑–Ω–∏–∫–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏:

```bash
ERROR [alembic.util.messaging] Target database is not up to date.
FAILED: Target database is not up to date.

ERROR [alembic.util.messaging] Multiple head revisions are present
FAILED: Multiple heads are present; please specify the head revision
```

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
- –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ `alembic heads` –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ –¥–≤–µ –≥–æ–ª–æ–≤–Ω—ã–µ —Ä–µ–≤–∏–∑–∏–∏ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ `alembic upgrade head` - –æ—à–∏–±–∫–∞ –æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥–æ–ª–æ–≤–∞—Ö
- –¢–∞–±–ª–∏—Ü—ã –≤ –ë–î —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏, –Ω–æ `alembic_version` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞
- –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ –ø–æ—è–≤–ª—è—Ç—å—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è

## 2. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏

1. **–†–∞–∑–¥–≤–æ–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π** - –∫–æ–≥–¥–∞ –¥–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–∑–¥–∞—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ—Ç –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏
2. **–†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ë–î** - —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –Ω–µ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏, –∞ –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ `Base.metadata.create_all()`
3. **–ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –º–∏–≥—Ä–∞—Ü–∏–π** - —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã `alembic_version`
4. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ –≤–µ—Ç–æ–∫** –≤ Git —Å —Ä–∞–∑–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

## 3. –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ

### –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞
–°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –±—ã–ª–∏ **–≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ Docker –æ–±—Ä–∞–∑** –ø—Ä–∏ —Å–±–æ—Ä–∫–µ, –ø–æ—ç—Ç–æ–º—É:
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ –Ω–µ –ø–æ–º–æ–≥–∞–ª–æ
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ–∞–π–ª—ã –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏—Å—å
- Alembic –≤–∏–¥–µ–ª –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π —Å "—Ä–∞–∑–¥–≤–æ–µ–Ω–∏–µ–º" (009 ‚Üí 010 –∏ 009 ‚Üí 8bd76168eb7e)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–≤–∞–ª–æ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ** - –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞", —á—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —á–µ—Ä–µ–∑ SQLAlchemy –Ω–∞–ø—Ä—è–º—É—é
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–±–ª–∏—Ü—ã alembic_version** - Alembic –Ω–µ –º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î
3. **–û—à–∏–±–∫–∞ –≤ alembic.ini** - –ø–∞—Ä–∞–º–µ—Ç—Ä `version_num_format = %04d` –≤—ã–∑—ã–≤–∞–ª `InterpolationSyntaxError` (–Ω—É–∂–Ω–æ `%%04d`)
4. **Volume mounting** - –∫–æ–¥ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è —Å —Ö–æ—Å—Ç–∞, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –æ–±—Ä–∞–∑ —Å–æ–¥–µ—Ä–∂–∞–ª —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤

## 4. –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É (–ø–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ)

### –®–∞–≥ 1: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose -f docker-compose.prod.yml down

# 2. –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ PostgreSQL (–í–°–ï –î–ê–ù–ù–´–ï –ë–£–î–£–¢ –ü–û–¢–ï–†–Ø–ù–´!)
rm -rf /opt/llm-bot/data/postgres/*

# 3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ —Ö–æ—Å—Ç–µ
rm -rf /opt/llm-bot/app/src/infrastructure/database/migrations/versions/*.py

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞—è
ls -la /opt/llm-bot/app/src/infrastructure/database/migrations/versions/
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π alembic.ini

```bash
cd /opt/llm-bot/app

cat > alembic.ini << 'EOF'
[alembic]
script_location = src/infrastructure/database/migrations
prepend_sys_path = .
version_path_separator = os
sqlalchemy.url = postgresql+asyncpg://postgres:password@postgres:5432/catalog_db

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console
qualname =

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
EOF
```

**–í–∞–∂–Ω–æ:** –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —á–∏—Å–ª–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ (0001, 0002 –≤–º–µ—Å—Ç–æ —Ö–µ—à–µ–π), –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É:
```ini
version_num_format = %%04d
```
(–∏–º–µ–Ω–Ω–æ –¥–≤–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞!)

### –®–∞–≥ 3: –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git

```bash
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å git (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
git config --global user.email "admin@server.com"
git config --global user.name "Server Admin"

# –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ
git add -A
git commit -m "Clean up migration files and fix alembic.ini"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
git status
```

### –®–∞–≥ 4: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ë–ï–ó –∫–µ—à–∞ (–≤–∞–∂–Ω–æ!)
docker-compose -f docker-compose.prod.yml build --no-cache app

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose -f docker-compose.prod.yml up -d

# –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–ø—É—Å–∫–∞ PostgreSQL
sleep 15

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å—ë –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
docker-compose -f docker-compose.prod.yml ps
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∏—Å—Ç–æ—Ç—É –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞–ø–∫–∞ versions –ø—É—Å—Ç–∞—è
docker-compose -f docker-compose.prod.yml exec app ls -la src/infrastructure/database/migrations/versions/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ alembic.ini –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
docker-compose -f docker-compose.prod.yml exec app cat /app/alembic.ini | head -10

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç heads
docker-compose -f docker-compose.prod.yml exec app alembic heads
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ –∏–ª–∏ –æ—à–∏–±–∫–∞
```

### –®–∞–≥ 6: –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
docker-compose -f docker-compose.prod.yml exec app alembic revision -m "initial"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–∑–¥–∞–ª–∞—Å—å
docker-compose -f docker-compose.prod.yml exec app alembic heads
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –æ–¥–∏–Ω head —Å —Ö–µ—à–æ–º

# –ü–æ–º–µ—Ç–∏—Ç—å –ë–î —ç—Ç–æ–π –≤–µ—Ä—Å–∏–µ–π (—Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç)
docker-compose -f docker-compose.prod.yml exec app alembic stamp head

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose -f docker-compose.prod.yml exec app alembic current
```

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É alembic_version
docker-compose -f docker-compose.prod.yml exec postgres psql -U postgres -d catalog_db -c "SELECT * FROM alembic_version;"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
docker-compose -f docker-compose.prod.yml exec postgres psql -U postgres -d catalog_db -c "\dt"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
docker-compose -f docker-compose.prod.yml exec app alembic history
```

## 5. –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫

### –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ `Base.metadata.create_all()` –≤ production
2. **–ö–æ–º–º–∏—Ç—å—Ç–µ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π** - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ Git
3. **–û–¥–∏–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ - –æ–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è** - –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
4. **–ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–π—Ç–µ –æ–±—Ä–∞–∑** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ï—Å–ª–∏ –≤ –∫–æ–¥–µ –µ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:

```python
# –ü–õ–û–•–û - –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ production
async with engine.begin() as conn:
    await conn.run_sync(Base.metadata.create_all)

# –•–û–†–û–®–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏–∏
# –£–¥–∞–ª–∏—Ç—å create_all –∏–∑ –∫–æ–¥–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/opt/llm-bot/app/
‚îú‚îÄ‚îÄ alembic.ini                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îî‚îÄ‚îÄ database/
‚îÇ           ‚îú‚îÄ‚îÄ models.py          # –ú–æ–¥–µ–ª–∏ SQLAlchemy
‚îÇ           ‚îî‚îÄ‚îÄ migrations/        # –ü–∞–ø–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ               ‚îú‚îÄ‚îÄ env.py         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ               ‚îú‚îÄ‚îÄ script.py.mako # –®–∞–±–ª–æ–Ω –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ               ‚îî‚îÄ‚îÄ versions/      # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
‚îÇ                   ‚îî‚îÄ‚îÄ [hash]_description.py
```

## 6. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow –º–∏–≥—Ä–∞—Ü–∏–π

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# 1. –ò–∑–º–µ–Ω–∏—Ç—å models.py –Ω–∞ —Ö–æ—Å—Ç–µ
# –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª—å

# 2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å autogenerate
docker-compose -f docker-compose.prod.yml exec app alembic revision --autogenerate -m "add_user_email_field"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏
# –§–∞–π–ª –ø–æ—è–≤–∏—Ç—Å—è –≤ src/infrastructure/database/migrations/versions/
cat src/infrastructure/database/migrations/versions/*_add_user_email_field.py

# 4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é
# Alembic –Ω–µ –≤—Å–µ–≥–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
docker-compose -f docker-compose.prod.yml exec app alembic upgrade head

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
docker-compose -f docker-compose.prod.yml exec app alembic current
docker-compose -f docker-compose.prod.yml exec postgres psql -U postgres -d catalog_db -c "\d+ table_name"
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –û—Ç–∫–∞—Ç –Ω–∞ –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞–∑–∞–¥
docker-compose -f docker-compose.prod.yml exec app alembic downgrade -1

# –û—Ç–∫–∞—Ç –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–≤–∏–∑–∏–∏
docker-compose -f docker-compose.prod.yml exec app alembic downgrade <revision_hash>

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
docker-compose -f docker-compose.prod.yml exec app alembic current
```

### –°–ª–∏—è–Ω–∏–µ –≤–µ—Ç–æ–∫ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

–ï—Å–ª–∏ –≤ Git –ø–æ—è–≤–∏–ª–∏—Å—å –¥–≤–µ –≥–æ–ª–æ–≤—ã –ø–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–æ–ª–æ–≤—ã
docker-compose -f docker-compose.prod.yml exec app alembic heads

# 2. –°–æ–∑–¥–∞—Ç—å merge –º–∏–≥—Ä–∞—Ü–∏—é
docker-compose -f docker-compose.prod.yml exec app alembic merge -m "merge_branches" <rev1> <rev2>

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å
docker-compose -f docker-compose.prod.yml exec app alembic upgrade head
```

### –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω

```bash
# 1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–∑ Git
cd /opt/llm-bot/app
git pull origin main

# 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
docker-compose -f docker-compose.prod.yml build app

# 3. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose -f docker-compose.prod.yml down

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose -f docker-compose.prod.yml up -d

# 5. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker-compose -f docker-compose.prod.yml exec app alembic upgrade head

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
docker-compose -f docker-compose.prod.yml exec app alembic current
```

## 7. –ù—É–∂–Ω–æ –ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ù–∞–π–¥–∏—Ç–µ –∏ —É–¥–∞–ª–∏—Ç–µ/–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:

```python
# src/infrastructure/database/connection.py –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Ñ–∞–π–ª

# ‚ùå –£–î–ê–õ–ò–¢–¨ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:
async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)  # –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏:
async def init_db():
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –µ—Å—Ç—å
    # –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ alembic upgrade head
    pass
```

### –ß—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–æ–¥–µ

–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞ –∏ –¥—Ä—É–≥—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å:

```python
async def init_db():
    # ‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏, –Ω–µ —Å—Ö–µ–º–æ–π
    async with AsyncSession(engine) as session:
        existing_admin = await session.scalar(
            select(AdminUser).where(AdminUser.username == "admin")
        )
        if not existing_admin:
            # –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞
            pass
```

## 8. –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã

1. **Volume mounting** - –∫–æ–≥–¥–∞ –∫–æ–¥ –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è —Å —Ö–æ—Å—Ç–∞, —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –≤ –æ–±—Ä–∞–∑–µ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å. –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–π—Ç–µ –æ–±—Ä–∞–∑ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞.

2. **Git –∏ –º–∏–≥—Ä–∞—Ü–∏–∏** - —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ Git. –û–Ω–∏ —á–∞—Å—Ç—å –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

3. **–§–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–π** - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `version_num_format`, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–π—Ç–µ: `%%04d` (–¥–≤–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–∞!)

4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - `alembic_version` - —Å–ª—É–∂–µ–±–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞. –ù–ï —É–¥–∞–ª—è–π—Ç–µ –µ—ë –≤—Ä—É—á–Ω—É—é, –ù–ï –∏–∑–º–µ–Ω—è–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.

5. **PostgreSQL –∏ –ø–∞—Ä–æ–ª—å** - –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `password`. –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥—ë–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

### üí° –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
2. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–∫–∞—Ç—ã** - —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `downgrade` —Ä–∞–±–æ—Ç–∞–µ—Ç
3. **–ë—ç–∫–∞–ø—ã** - –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ö—Ä–∞–Ω–∏—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
5. **CI/CD** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –º–∏–≥—Ä–∞—Ü–∏–π –≤ pipeline

### üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
alembic current

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≥–æ–ª–æ–≤—ã
alembic heads

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é
alembic history

# –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic show <revision>

# –°–æ–∑–¥–∞—Ç—å SQL-—Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
alembic upgrade head --sql

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
alembic upgrade head --sql > migration.sql
```

### üîß Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞:** "Target database is not up to date"
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `alembic_version`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `alembic stamp head`

**–ü—Ä–æ–±–ª–µ–º–∞:** "Multiple heads"
- **–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–π—Ç–µ merge –º–∏–≥—Ä–∞—Ü–∏—é –∏–ª–∏ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–∫–∞–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ 4)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è
- **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `target_metadata = Base.metadata` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `env.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ models.py –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –º–∏–≥—Ä–∞—Ü–∏—é
- **–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –º–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `models.py` –∏ `Base` –∑–Ω–∞–µ—Ç –æ –Ω–µ–π

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 19.10.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç