# üß™ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ò–ò-–±–æ—Ç–∞

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –≤ production.

## üéØ –¶–µ–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ª–∞–¥–∫–∞** - —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è** - –Ω–µ –≤–ª–∏—è–µ–º –Ω–∞ production —Å—Ä–µ–¥—É  
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
- ‚úÖ **E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏** - –ø–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ—Ç–æ–∫–∏
- ‚úÖ **–û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –ª–µ–≥–∫–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### Windows (PowerShell)
```powershell
# 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É
.\scripts\test_local.ps1 setup

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
.\scripts\test_local.ps1 start
.\scripts\test_local.ps1 test

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
.\scripts\test_local.ps1 status
```

### Linux/Mac (Bash) 
```bash
# 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É
./scripts/test_local.sh setup

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã  
./scripts/test_local.sh start
./scripts/test_local.sh test

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
./scripts/test_local.sh status
```

### Make (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ)
```bash
# –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ Makefile
make setup         # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å–µ
make test-local     # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É
make test           # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
make check          # –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```

## üê≥ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   App-Test      ‚îÇ    ‚îÇ   Bot-Test      ‚îÇ    ‚îÇ PostgreSQL-Test ‚îÇ
‚îÇ   Port: 8001    ‚îÇ    ‚îÇ  (Background)   ‚îÇ    ‚îÇ   Port: 5433    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Pytest-Runner  ‚îÇ
                    ‚îÇ  (On-demand)    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Ç–ª–∏—á–∏—è –æ—Ç Production
| –ê—Å–ø–µ–∫—Ç | Production | Local Test |
|---------|------------|------------|
| **–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** | 8000 | 8001 |
| **–ü–æ—Ä—Ç –ë–î** | 5432 (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π) | 5433 |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è | –¢–µ—Å—Ç–æ–≤–∞—è |
| **–î–∞–Ω–Ω—ã–µ** | –†–µ–∞–ª—å–Ω—ã–µ | –¢–µ—Å—Ç–æ–≤—ã–µ |
| **Hot Reload** | ‚ùå | ‚úÖ |
| **Debug —Ä–µ–∂–∏–º** | ‚ùå | ‚úÖ |

## üìã –ö–æ–º–∞–Ω–¥—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–æ–π
```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑)
make setup
./scripts/test_local.sh setup

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã
make test-local
./scripts/test_local.sh start

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ä–µ–¥—ã
./scripts/test_local.sh stop

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
./scripts/test_local.sh clean
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
make test
./scripts/test_local.sh test

# –ü–æ —Ç–∏–ø–∞–º
./scripts/test_local.sh test-unit    # Unit —Ç–µ—Å—Ç—ã (–±—ã—Å—Ç—Ä–æ)
./scripts/test_local.sh test-int     # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ
./scripts/test_local.sh test-e2e     # E2E —Ç–µ—Å—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω–æ)

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
make coverage
./scripts/test_local.sh coverage

# –í —Ä–µ–∂–∏–º–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è (–∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫)
make watch
./scripts/test_local.sh test-watch
```

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è
make lint
./scripts/test_local.sh lint

# –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
make format
./scripts/test_local.sh format

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (lint + unit —Ç–µ—Å—Ç—ã)
make check
./scripts/test_local.sh check
```

### –û—Ç–ª–∞–¥–∫–∞
```bash
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–±–æ–ª–æ—á–∫–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
./scripts/test_local.sh shell

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
./scripts/test_local.sh db-shell

# –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
./scripts/test_local.sh logs app-test

# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./scripts/test_local.sh status
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.test)
```env
DEBUG=true
ENVIRONMENT=test
DATABASE_URL=postgresql+asyncpg://test_user:test_pass@localhost:5433/test_catalog_db
BOT_TOKEN=test_bot_token_for_local_testing
DEFAULT_LLM_PROVIDER=test
LEAD_INACTIVITY_THRESHOLD=1
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: `chat_id=999999`, `test_user`
- **LLM –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**: —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: —á–∏—Å—Ç–∞—è PostgreSQL —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

## üß¨ –ú–æ–∫–∏ –∏ —Ñ–∏–∫—Å—Ç—É—Ä—ã

### LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä
```python
# –í —Ç–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è MockLLMProvider
mock_llm = MockLLMProvider()
mock_llm.set_responses([
    "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
    "–ù–∞–π–¥–µ–Ω–æ 5 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É..."
])
```

### Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```python
# –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
mock_notifier = MockTelegramNotifier()
# –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
assert len(mock_notifier.sent_notifications) == 1
```

### CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```python
# –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ —É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫—É
mock_crm = MockCRMService()
mock_crm.set_failure(True, "Test CRM error")
```

## üìä –û—Ç—á–µ—Ç—ã

### –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
–ü–æ—Å–ª–µ `make coverage`:
- **HTML –æ—Ç—á–µ—Ç**: `htmlcov/index.html`
- **–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π**: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
- **JUnit XML**: `test-results/results.xml`
- **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏**: –≤ –∫–æ–Ω—Å–æ–ª–∏

## üîÑ –†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
```bash
# 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ä–µ–¥—É (–æ–¥–∏–Ω —Ä–∞–∑)
make setup

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ä–µ–¥—É
make test-local

# 3. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏
make watch  # –¢–µ—Å—Ç—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
make check

# 5. –î–µ–ø–ª–æ–π –µ—Å–ª–∏ –≤—Å–µ –û–ö
make deploy
```

### –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω—É–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã
./scripts/test_local.sh test -k "test_lead_creation"

# 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
./scripts/test_local.sh logs

# 3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
./scripts/test_local.sh shell

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
./scripts/test_local.sh db-shell
```

## üö® Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### "Port already in use"
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ
./scripts/test_local.sh stop

# –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
docker compose -f docker-compose.test.yml down
```

#### "Database connection failed"  
```bash
# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î
./scripts/test_local.sh clean
./scripts/test_local.sh setup
```

#### "Tests fail with import errors"
```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã
./scripts/test_local.sh clean
docker compose -f docker-compose.test.yml build --no-cache
```

#### "Hot reload doesn't work"
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ volume –º–∞–ø–ø–∏–Ω–≥ –≤ `docker-compose.test.yml`:
```yaml
volumes:
  - ./src:/app/src  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã
```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker compose -f docker-compose.test.yml ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl http://localhost:8001/health

# –õ–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
docker compose -f docker-compose.test.yml logs app-test
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IDE

### VS Code
```json
// .vscode/tasks.json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Test Local",
            "type": "shell",
            "command": "./scripts/test_local.sh test",
            "group": "test"
        }
    ]
}
```

### PyCharm
- **Run Configuration**: External Tool
- **Program**: `./scripts/test_local.sh`
- **Arguments**: `test`

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
```bash
# –ü–æ–∫–∞–∑–∞—Ç—å —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
./scripts/test_local.sh test --durations=10

# –¢–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (< 1 —Å–µ–∫)
./scripts/test_local.sh test -m "not slow"
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
./scripts/test_local.sh test -n auto
```

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
```bash
# –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
./scripts/test_local.sh test -m db

# –í—Å–µ –∫—Ä–æ–º–µ E2E
./scripts/test_local.sh test -m "not e2e"
```

---

**–ü—Ä–∏–Ω—Ü–∏–ø:** –¢–µ—Å—Ç–∏—Ä—É–π –ª–æ–∫–∞–ª—å–Ω–æ, –¥–µ–ø–ª–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ! üß™‚úÖ
