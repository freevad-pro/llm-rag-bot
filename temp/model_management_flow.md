# Схема работы управления моделью

## 1. Первый запуск на новом сервере

```
┌─────────────────────────────────────────────────────────────┐
│  Деплой приложения                                           │
│  docker compose up -d                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Приложение запущено                                         │
│  ⚠️  Модель эмбеддингов НЕ загружена                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Администратор → /admin/model/                              │
│  Видит: ❌ Модель не загружена                              │
│  Действие: Нажимает "Скачать модель"                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Фоновая задача загрузки                                    │
│  ├─ 0-10%:  Подготовка                                      │
│  ├─ 10-90%: Загрузка с HuggingFace (~350 MB)                │
│  └─ 90-100%: Проверка работоспособности                     │
│                                                              │
│  ⏱️  Время: 5-10 минут                                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  ✅ Модель загружена                                         │
│  Размер: ~350 MB                                             │
│  Кэш: /root/.cache/torch/sentence_transformers/             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Теперь можно загружать каталог                             │
│  /admin/catalog/upload → Кнопка активна                     │
└─────────────────────────────────────────────────────────────┘
```

## 2. Попытка загрузить каталог БЕЗ модели

```
┌─────────────────────────────────────────────────────────────┐
│  Менеджер → /admin/catalog/upload                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Проверка модели                                            │
│  if embedding_provider == "sentence-transformers":          │
│      check_model_exists() → False                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  ⚠️  Предупреждение на странице:                            │
│  "Модель не загружена. Перейдите в раздел..."              │
│                                                              │
│  🔒 Кнопка "Загрузить каталог" ЗАБЛОКИРОВАНА               │
│                                                              │
│  👉 Ссылка для администратора:                              │
│     "Перейти к загрузке модели →"                           │
└─────────────────────────────────────────────────────────────┘
```

## 3. Попытка обойти через API

```
┌─────────────────────────────────────────────────────────────┐
│  POST /admin/catalog/upload                                 │
│  Content-Type: multipart/form-data                          │
│  file: catalog.xlsx                                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  Backend проверка                                           │
│  if embedding_provider == "sentence-transformers":          │
│      if not model_exists():                                 │
│          raise HTTPException(400, "Модель не загружена")    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  ❌ HTTP 400 Bad Request                                     │
│  {                                                           │
│    "detail": "Модель эмбеддингов не загружена..."          │
│  }                                                           │
└─────────────────────────────────────────────────────────────┘
```

## 4. Управление моделью - полный цикл

```
┌─────────────────────────────────────────────────────────────┐
│  Страница: /admin/model/                                    │
│  (Доступна только администраторам)                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┬─────────────┬───────────┐
        │                           │             │           │
        ▼                           ▼             ▼           ▼
  ┌──────────┐              ┌──────────┐   ┌──────────┐ ┌──────────┐
  │ Скачать  │              │Обновить  │   │Перезагр. │ │ Удалить  │
  │  модель  │              │  статус  │   │          │ │  модель  │
  └────┬─────┘              └────┬─────┘   └────┬─────┘ └────┬─────┘
       │                         │              │            │
       │  POST /admin/           │  GET /admin/ │ POST       │ DELETE
       │  model/download         │  model/      │ /admin/    │ /admin/
       │                         │  status      │ model/     │ model/
       │                         │              │ download   │
       ▼                         ▼              ▼            ▼
  ┌──────────────────────────────────────────────────────────────┐
  │                 Глобальный статус _download_status            │
  │  {                                                            │
  │    "is_downloading": bool,                                    │
  │    "progress": 0-100,                                         │
  │    "message": str,                                            │
  │    "error": str | None                                        │
  │  }                                                            │
  └──────────────────────┬───────────────────────────────────────┘
                         │
                         │ Обновление каждые 2 секунды
                         │ (JavaScript setInterval)
                         │
                         ▼
  ┌──────────────────────────────────────────────────────────────┐
  │  UI обновляется динамически:                                 │
  │  - Прогресс-бар                                              │
  │  - Процент выполнения                                        │
  │  - Текстовое сообщение                                       │
  │  - Активация/деактивация кнопок                              │
  └──────────────────────────────────────────────────────────────┘
```

## 5. Состояния кнопок

| Состояние модели      | Скачать | Перезагрузить | Удалить | Отменить |
|-----------------------|---------|---------------|---------|----------|
| ❌ Не загружена       | ✅      | ❌            | ❌      | ❌       |
| ⏳ Загружается       | ❌      | ❌            | ❌      | ✅       |
| ✅ Загружена          | ❌      | ✅            | ✅      | ❌       |

## 6. Интеграция с индексацией

```
┌─────────────────────────────────────────────────────────────┐
│  Загрузка каталога → Индексация                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  catalog_management.py:reindex_catalog()                    │
│  progress: 10-90%                                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│  sentence_transformers_embeddings.py                        │
│  _initialize_model()                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
  ┌──────────┐              ┌──────────────┐
  │ Модель   │              │ Модель НЕ    │
  │ в кэше   │              │ в кэше       │
  └────┬─────┘              └──────┬───────┘
       │                           │
       │ Загрузка из кэша         │ Попытка загрузки
       │ (быстро)                  │ из HuggingFace
       │                           │ (медленно, может таймаут)
       ▼                           ▼
  ┌──────────┐              ┌──────────────┐
  │ ✅ OK    │              │ ❌ ОШИБКА    │
  │ Индекса- │              │ ReadTimeout  │
  │ ция идёт │              │ → зависание  │
  └──────────┘              └──────────────┘
```

## 7. Роли и доступ

```
┌──────────────────────────────────────────────────────────────┐
│                     Роль: АДМИНИСТРАТОР                       │
├──────────────────────────────────────────────────────────────┤
│  ✅ Видит пункт меню "Модель эмбеддингов"                    │
│  ✅ Доступ к странице /admin/model/                          │
│  ✅ Может скачивать/удалять/перезагружать модель              │
│  ✅ Видит ссылку на модель в предупреждении загрузки         │
│  ✅ Может загружать каталог                                   │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                     Роль: МЕНЕДЖЕР                            │
├──────────────────────────────────────────────────────────────┤
│  ❌ НЕ видит пункт меню "Модель эмбеддингов"                 │
│  ❌ НЕ может открыть /admin/model/ (403 Forbidden)           │
│  ⚠️  Видит предупреждение если модель не загружена           │
│  ❌ НЕ видит ссылку на загрузку модели                        │
│  ✅ Может загружать каталог (если модель загружена админом)  │
└──────────────────────────────────────────────────────────────┘
```

## 8. Файловая структура

```
llm-rag-bot/
├── src/
│   ├── application/web/routes/
│   │   └── model_management.py       # ← API endpoints
│   ├── presentation/templates/admin/
│   │   └── model_management.html     # ← UI страницы
│   └── infrastructure/search/
│       └── sentence_transformers_embeddings.py  # Использует модель
├── scripts/
│   └── check_model.sh               # ← Проверка статуса
├── docs/
│   ├── model_management_guide.md    # ← Полная документация
│   └── QUICK_MODEL_SETUP.md         # ← Быстрый старт
└── Dockerfile                       # ← БЕЗ предзагрузки модели

Docker Container:
/root/.cache/torch/sentence_transformers/
└── sentence-transformers_paraphrase-multilingual-MiniLM-L12-v2/
    ├── config.json
    ├── model.safetensors (~350 MB)
    ├── tokenizer_config.json
    └── ... (другие файлы)
```

---

**Примечание**: Схемы показывают логику работы с учётом всех проверок и граничных случаев.

