# Улучшения прогресса и кнопок управления

## Реализовано

### 1. ✅ Живой прогресс-бар во время загрузки

**Проблема:** `snapshot_download` работает синхронно без callbacks → прогресс застревал на 25% на 5-15 минут.

**Решение:** Параллельная симуляция прогресса!

```python
async def simulate_progress():
    """Симуляция прогресса во время долгой загрузки."""
    for progress in range(25, 76):
        if not _download_status["is_downloading"]:
            break
        _download_status["progress"] = progress
        
        # Динамические сообщения
        if progress < 40:
            message = f"Скачивание... {progress}% (5-15 минут)"
        elif progress < 60:
            message = f"Загрузка продолжается... {progress}% (~10 минут)"
        else:
            message = f"Почти готово... {progress}% (~5 минут)"
        
        _download_status["message"] = message
        await asyncio.sleep(12)  # Обновление каждые 12 секунд

# Запускаем параллельно с реальной загрузкой
progress_task = asyncio.create_task(simulate_progress())
local_dir = await asyncio.to_thread(snapshot_download, ...)

# Останавливаем симуляцию когда загрузка завершится
progress_task.cancel()
```

**Результат:**
- Прогресс плавно растёт от 25% до 75% за время загрузки
- Сообщения меняются каждые 12 секунд
- Пользователь видит что процесс идёт

**Прогресс теперь:**
```
 5% → 10% → 15% → 20%
 ↓
25% "Скачивание... 25% (5-15 минут)"
26% "Скачивание... 26%..."
...
40% "Загрузка продолжается... 40% (~10 минут)"
...
60% "Почти готово... 60% (~5 минут)"
...
75% "Почти готово... 75%..."
 ↓ [реальная загрузка завершена]
80% "Модель скачана, инициализация..."
85% "Проверка работоспособности..."
92% "Тестирование эмбеддингов..."
98% "Финализация..."
100% "✅ Модель готова!"
```

### 2. ✅ Умные кнопки

**Было:**
- Все кнопки всегда видны
- Отмена появлялась вместе с остальными
- Неясно что можно делать во время загрузки

**Стало:**

#### HTML структура:
```html
<div id="actionButtons">
    <!-- Нормальное состояние -->
    <div id="normalButtons">
        <button>Скачать</button> или
        <button>Удалить</button> + <button>Перезагрузить</button>
    </div>
    
    <!-- Во время загрузки -->
    <button id="cancelBtn">Отменить загрузку</button>
</div>
```

#### Состояния:

| Состояние | Видимые кнопки |
|-----------|----------------|
| ❌ Модель не загружена | "Скачать модель" |
| ✅ Модель загружена | "Удалить" + "Перезагрузить" |
| ⏳ Идёт загрузка | "Отменить загрузку" |

#### JavaScript логика:
```javascript
if (data.is_downloading) {
    // Скрываем обычные кнопки
    normalButtons.style.display = 'none';
    // Показываем только кнопку отмены
    cancelBtn.style.display = 'inline-block';
} else {
    // Показываем обычные кнопки
    normalButtons.style.display = 'block';
    // Скрываем кнопку отмены
    cancelBtn.style.display = 'none';
}
```

### 3. ✅ Повторная загрузка не перекачивает всё

`snapshot_download` с `resume_download=True`:
- ✅ Проверяет ETag существующих файлов
- ✅ Загружает только изменившиеся файлы
- ✅ Не качает заново то, что уже есть

**Пример:**
```python
# Первый запуск: скачивает все 470 MB
snapshot_download(resume_download=True)

# Второй запуск: проверяет хеши, ничего не качает
snapshot_download(resume_download=True)  # Быстро!
```

### 4. ⚠️ Отмена загрузки

**Текущая реализация:**
```python
@model_router.post("/cancel")
async def cancel_download():
    _download_status["is_downloading"] = False
    _download_status["message"] = "Загрузка отменена"
```

**Что происходит:**
- ✅ Флаг `is_downloading` сбрасывается
- ✅ UI показывает что загрузка отменена
- ⚠️ Фоновая задача `snapshot_download` **продолжает работать**
- ⚠️ Файлы продолжают качаться в фоне
- ✅ При следующем запуске докачает с того места

**Почему так:**
- `asyncio.to_thread()` нельзя прервать извне
- `snapshot_download` блокирующая функция
- Можно только дождаться завершения или таймаута

**Для пользователя это ОК:**
- Нажал "Отменить" → кнопки разблокировались
- Может попробовать снова
- Файлы не теряются благодаря `resume_download=True`

## Файлы изменены

### 1. `src/application/web/routes/model_management.py`
- Добавлена функция `simulate_progress()` для живого прогресса
- Параллельный запуск симуляции и реальной загрузки
- Автоматическая остановка симуляции при завершении

### 2. `src/presentation/templates/admin/model_management.html`
- Разделены кнопки на `normalButtons` и `cancelBtn`
- JavaScript переключает видимость в зависимости от состояния
- Улучшены сообщения с оценкой времени

## Пользовательский опыт

### До улучшений:
```
Нажал "Скачать"
  ↓
Прогресс 25%
  ↓
[застыло на 10 минут]
  ↓
Пользователь: "Зависло? Работает?"
  ↓
Смотрит логи на сервере
```

### После улучшений:
```
Нажал "Скачать"
  ↓
Toast: "Загрузка начата"
  ↓
Обычные кнопки исчезли
Появилась кнопка "Отменить загрузку"
  ↓
Прогресс: 25% → 26% → 27% ...
Сообщения меняются каждые 12 сек
  ↓
Пользователь: "Ок, работает, жду"
  ↓
100% → Toast "Успешно!" → Перезагрузка страницы
```

### Если зависло:
```
Прогресс застрял
  ↓
Нажал "Отменить загрузку"
  ↓
Кнопки вернулись
  ↓
Попробовать снова
```

## Технические детали

### Таймаут симуляции
```python
await asyncio.sleep(12)  # 12 секунд между обновлениями
```

**Расчёт:**
- Диапазон: 25% → 75% = 51 шаг
- 51 * 12 сек = 612 сек ≈ 10 минут
- Реальная загрузка: 5-15 минут
- Симуляция покрывает среднее время

### Остановка симуляции
```python
progress_task.cancel()
try:
    await progress_task
except asyncio.CancelledError:
    pass  # Это нормально
```

Корректная отмена asyncio задачи без ошибок.

---

**Итого:**
- ✅ Прогресс-бар живой и информативный
- ✅ Кнопки меняются по контексту
- ✅ Повторная загрузка умная (не качает заново)
- ⚠️ Отмена работает для UI (фон качает дальше, но это ОК)

**Дата:** 20.10.2025

