# Техническое задание на разработку AI-агента для консультирования клиентов

**Версия:** 1.0  
**Дата:** Январь 2025  
**Статус:** На согласовании

---

## 1. Общие положения

### 1.1. Назначение системы
Разработка интеллектуального AI-агента для автоматизированного консультирования клиентов компании по поставке оборудования и запчастей, с функциями поиска по каталогу товаров, квалификации лидов и интеграции с CRM системой.

### 1.2. Цели проекта
- Автоматизация первичного консультирования клиентов 24/7
- Сокращение нагрузки на менеджеров по продажам
- Увеличение конверсии посетителей в лиды
- Структурированный сбор контактных данных потенциальных клиентов

### 1.3. Основные метрики успеха
- Обработка 2,000-4,000 уникальных пользователей
- Поддержка 10-50 одновременных диалогов
- Время ответа на запрос < 2 секунды
- Доступность системы > 99.5%
- Успешная синхронизация с CRM > 98% лидов

---

## 2. Функциональные требования

### 2.1. Каналы взаимодействия

#### 2.1.1. Telegram бот
- **Основной канал** взаимодействия с клиентами
- Поддержка команд: `/start`, `/help`, `/contact`, `/categories`
- Inline-кнопки для навигации по категориям
- Отправка фотографий товаров
- Кнопка быстрой отправки контактов
- **Мультиязычность**: автоматические ответы на языке пользователя через LLM

#### 2.1.2. Веб-виджет (Фаза 2)
- Встраиваемый чат-виджет для сайта компании
- WebSocket соединение для real-time общения
- Адаптивный дизайн для мобильных устройств
- Сохранение истории в рамках сессии
- **Мультиязычность**: автоматические ответы на языке пользователя через LLM

### 2.2. Поиск и консультирование

#### 2.2.1. Поиск по каталогу товаров
- **Источник данных**: Excel файлы с 40,000+ позиций (окончательное решение)
- **Обязательные поля**: 
  - `id` - уникальный идентификатор
  - `section name 1` - наименование раздела
  - `section name 2` - наименование подраздела
  - `product name` - наименование товара
  - `description` - описание
  - `category 1` - категория 1-го уровня
  - `category 2` - категория 2-го уровня
  - `category 3` - категория 3-го уровня
  - `article` - артикул
- **Опциональные поля**:
  - `photo_url` - ссылка на фото товара
  - `page_url` - ссылка на страницу товара на сайте
  - Любые другие колонки игнорируются и не мешают работе
- **Технология**: векторный поиск через Chroma DB
- **Возможности**:
  - Семантический поиск по описанию
  - Фильтрация по категориям
  - Показ фото товаров
  - Вывод до 10 результатов за запрос

#### 2.2.2. Консультирование по услугам компании
- База знаний услуг хранится в PostgreSQL
- Контекстный поиск по ключевым словам
- Генерация ответов через LLM с учетом контекста компании
- Возможность редактирования через админ-панель

#### 2.2.3. Классификация запросов
Автоматическое определение типа запроса:
- `PRODUCT` - поиск конкретного товара
- `SERVICE` - вопрос об услугах компании  
- `GENERAL` - общий вопрос
- `CONTACT` - желание связаться с менеджером

### 2.3. Сбор и обработка лидов

#### 2.3.1. Сбор контактных данных
**Обязательные поля**:
- Имя клиента
- Телефон (с валидацией формата)

**Опциональные поля**:
- Email
- Вопрос/потребность
- Telegram username (автоматически)

#### 2.3.2. Интеграция с Zoho CRM
- Использование Zoho CRM API v3
- Создание лидов в режиме real-time
- **Механизм retry**: максимум 2 попытки синхронизации
- Локальное сохранение в PostgreSQL для надежности
- Уведомления о статусе синхронизации

### 2.4. История и персонализация

#### 2.4.1. Хранение диалогов
- Полная история сообщений в PostgreSQL
- Контекст последних 20 сообщений для LLM
- Привязка к `chat_id` в Telegram
- Возможность просмотра через админ-панель

#### 2.4.2. Персонализация
- Запоминание имени пользователя
- История предыдущих запросов
- Рекомендации на основе истории поиска

### 2.5. Вызов менеджера

#### 2.5.1. Инициация
- Команда `/contact` или кнопка "Связаться с менеджером"
- Автоматическое предложение при сложных вопросах

#### 2.5.2. Обработка запроса
- Сбор контактных данных клиента (имя, телефон, вопрос)
- Создание лида в системе и CRM
- Telegram уведомление в группу менеджеров с контактами клиента
- Email уведомление менеджерам (опционально)

---

## 3. Административный функционал

### 3.1. Админ-панель

#### 3.1.1. Доступ и роли

| Функция | Менеджер | Администратор |
|---------|----------|---------------|
| Просмотр статистики | ✅ Базовая | ✅ Полная |
| Загрузка каталога Excel | ✅ | ✅ |
| Редактирование промптов | ✅ | ✅ |
| Управление услугами | ✅ | ✅ |
| Просмотр истории диалогов | ✅ | ✅ |
| Выбор LLM провайдера | ❌ | ✅ |
| Деплой из GitHub | ❌ | ✅ |
| Просмотр системных логов | ❌ | ✅ |
| Управление уведомлениями | ❌ | ✅ |

#### 3.1.2. Управление каталогом
- Загрузка нового Excel файла через веб-интерфейс
- Валидация структуры файла
- Планирование переиндексации (немедленно или по расписанию)
- Blue-green deployment для обновления без простоя
- История версий каталога

#### 3.1.3. Управление промптами
- Редактирование системных промптов:
  - `system_prompt` - основной системный промпт с инструкцией отвечать на языке пользователя
  - `product_search_prompt` - для поиска товаров
  - `service_answer_prompt` - для ответов об услугах
  - `general_conversation_prompt` - для общих вопросов
  - `lead_qualification_prompt` - для квалификации лидов
- Версионирование промптов
- A/B тестирование промптов (опционально)

#### 3.1.4. Выбор LLM провайдера
- Поддерживаемые провайдеры:
  - OpenAI GPT (по умолчанию)
  - YandexGPT
  - Anthropic Claude (будущее расширение)
- Горячее переключение без перезапуска
- Настройка параметров генерации (temperature, max_tokens)

### 3.2. Статистика и метрики

#### 3.2.1. Оперативная статистика
- Количество активных пользователей (день/неделя/месяц)
- Количество обработанных запросов
- Среднее время ответа
- Топ-10 запрашиваемых товаров
- Конверсия в лиды

#### 3.2.2. Бизнес-метрики
- Количество созданных лидов
- Статус синхронизации с CRM
- Распределение запросов по категориям
- Пиковые часы нагрузки

---

## 4. Технические требования

### 4.1. Архитектура системы

#### 4.1.1. Технологический стек
| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Язык программирования | Python 3.11+ | Экосистема AI/ML |
| Telegram Bot Framework | aiogram 3.x | Асинхронность, производительность |
| Web Framework | FastAPI | WebSocket, автодокументация |
| Векторная БД | Chroma | Простота, встроенная персистентность |
| Реляционная БД | PostgreSQL 15 | Надежность, JSONB |
| Кэширование | TTLCache (in-memory) | Достаточно для нагрузки |
| Контейнеризация | Docker Compose | Простота деплоя |

#### 4.1.2. Структура данных

**PostgreSQL** хранит:
- Пользователи и их данные
- История диалогов
- Лиды и статус синхронизации
- Услуги компании
- Системные настройки и промпты
- Логи критических событий

**Chroma DB** хранит:
- Векторные представления товаров
- Метаданные товаров
- Индексы для быстрого поиска

**Файловая система** хранит:
- Загруженные Excel/PDF файлы
- Временные файлы
- Debug логи

### 4.2. Производительность

#### 4.2.1. Требования к производительности
- Время индексации каталога: < 10 минут для 40,000 товаров
- Время поиска по каталогу: < 500мс
- Время генерации ответа LLM: < 2 секунды
- Пропускная способность: 50 одновременных пользователей
- Размер векторной БД: ~1-2 GB для 40,000 товаров
- Кэширование результатов поиска: TTL 5 минут для снижения нагрузки на LLM API

#### 4.2.2. Масштабирование
- Вертикальное масштабирование до 100 одновременных пользователей
- Кэширование частых запросов (TTL 5 минут)
- Connection pooling для PostgreSQL (20 соединений)

### 4.3. Надежность

#### 4.3.1. Отказоустойчивость
- Автоматический перезапуск при сбоях (Docker restart policy)
- Graceful shutdown с сохранением состояния
- Retry механизм для внешних API (CRM, LLM)
- Fallback на локальное сохранение при недоступности CRM

#### 4.3.2. Резервное копирование
- Ежедневный backup PostgreSQL
- Backup Chroma DB перед переиндексацией
- Хранение backup за последние 7 дней
- Возможность быстрого восстановления (< 30 минут)

### 4.4. Безопасность

#### 4.4.1. Аутентификация и авторизация
- Админ-панель защищена паролем
- Разделение ролей (менеджер/администратор)
- Токены для API в переменных окружения

#### 4.4.2. Защита данных
- HTTPS для веб-интерфейса
- Валидация входных данных
- Защита от SQL инъекций (параметризованные запросы)
- Логирование подозрительной активности

---

## 5. Мониторинг и логирование

### 5.1. Система мониторинга

#### 5.1.1. Health checks
- HTTP endpoint `/health` для проверки состояния
- Проверка доступности БД
- Проверка доступности Telegram API
- Проверка свободного места на диске

#### 5.1.2. Внешний мониторинг
- UptimeRobot - проверка доступности каждые 5 минут
- Healthchecks.io - dead man's switch для критических процессов

### 5.2. Система уведомлений

#### 5.2.1. Каналы уведомлений
- **Telegram** (приоритетный):
  - Критические ошибки
  - Недоступность сервисов
  - Успешные деплои
- **Email** (дополнительный):
  - Дайджест ошибок
  - Отчеты о работе

#### 5.2.2. Настройка получателей
- Список Telegram chat_id для алертов
- Список email для отчетов
- Разные уровни уведомлений (CRITICAL, ERROR, WARNING)

### 5.3. Логирование

#### 5.3.1. Уровни логирования
- **CRITICAL** → Telegram + БД
- **ERROR** → БД + файл
- **WARNING** → БД + файл
- **INFO** → файл
- **DEBUG** → файл (в dev режиме)

#### 5.3.2. Ротация логов
- Максимальный размер файла: 5 MB
- Количество backup файлов: 2
- Очистка логов старше 30 дней из БД

---

## 6. Deployment и обновления

### 6.1. Инфраструктура

#### 6.1.1. Требования к VPS
- **Минимальные требования**:
  - 4 vCPU
  - 8 GB RAM
  - 60 GB NVMe SSD
  - Ubuntu 22.04 LTS
- **Рекомендуемый провайдер**: Timeweb
- **Возможность миграции**: Docker-based архитектура

### 6.2. Процесс развертывания

#### 6.2.1. Первичное развертывание
1. Подготовка VPS (Docker, Docker Compose)
2. Клонирование репозитория из GitHub
3. Настройка переменных окружения
4. Запуск через Docker Compose
5. Инициализация БД и индексация каталога
6. Настройка webhook для Telegram

#### 6.2.2. Обновление кода
- Pull из GitHub (ручной или через админку)
- Пересборка Docker контейнера приложения
- Blue-green deployment (без downtime)
- Сохранение данных (PostgreSQL, Chroma, файлы)
- Автоматическая проверка health после деплоя

### 6.3. Версионирование

#### 6.3.1. Git стратегия
- Основная ветка: `main` (production)
- Разработка: `develop`
- Feature branches: `feature/название`
- Semantic versioning: `v1.0.0`

#### 6.3.2. CI/CD (опционально)
- GitHub Actions для автотестов
- Автоматический деплой при push в main
- Откат к предыдущей версии при ошибке

### 6.4 Настройки поиска по каталогу

#### 6.4.1. Алгоритм поиска
- **Векторная БД**: Chroma с cosine similarity
- **Embeddings**: SentenceTransformers (CPU-оптимизированные)
- **Boost система**: Приоритет совпадениям в артикуле и названии

#### 6.4.2. Конфигурируемые параметры
- `SEARCH_MIN_SCORE` - минимальный score для показа результатов (по умолчанию: 0.45)
- `SEARCH_NAME_BOOST` - boost за совпадения в названии товара (по умолчанию: 0.2)
- `SEARCH_ARTICLE_BOOST` - boost за совпадения в артикуле (по умолчанию: 0.3)
- `SEARCH_MAX_RESULTS` - максимальное количество результатов (по умолчанию: 10)

#### 6.4.3. Иерархия категорий
Поиск работает по всем трем уровням:
- **category 1** - основная категория (например: "Электроника")
- **category 2** - подкатегория (например: "Компьютеры")
- **category 3** - детальная категория (например: "Ноутбуки")

---

## 7. Интеграции

### 7.1. Zoho CRM

#### 7.1.1. Требования
- API версия: v3
- Методы: Create Lead, Update Lead
- Поля для передачи:
  - Last_Name (обязательное)
  - Email (только если есть)
  - Phone (только если есть)
  - Whatsapp (только если есть телефон - записываем телефон)
  - Company (только если есть наименование компании)
  - Lead_First_Communication_Channel: "TG" или "SalesIQ Chat"
  - Telegram (если через ТГ)
  - Description (вопрос клиента)

#### 7.1.2. Обработка ошибок
- Максимум 2 попытки синхронизации
- Интервал между попытками: 30 минут
- Уведомление менеджеров при неудаче
- Локальное сохранение для ручной обработки

### 7.2. Будущие интеграции (Roadmap)

#### 7.2.1. API автозапчастей (возможность расширения)
- Архитектура поддерживает добавление внешних API
- Возможность интеграции с каталогами запчастей в будущем
- Поиск по VIN коду
- Кросс-референсы аналогов

---

## 8. Этапы реализации

### Фаза 1: MVP (2-3 недели)
- [x] Архитектура и структура проекта
- [ ] Базовый Telegram бот
- [ ] Индексация и поиск по каталогу (Chroma)
- [ ] Сбор контактов
- [ ] Простая админка для загрузки Excel

### Фаза 2: Production Ready (2-3 недели)
- [ ] Полноценная админ-панель
- [ ] Интеграция с Zoho CRM
- [ ] Система уведомлений
- [ ] Веб-виджет для сайта
- [ ] Мониторинг и алерты

### Фаза 3: Оптимизация (1-2 недели)
- [ ] Улучшение качества поиска
- [ ] A/B тестирование промптов
- [ ] Автоматический деплой из GitHub
- [ ] Расширенная аналитика

### Фаза 4: Расширение функционала (НЕ НУЖНО)
- ~~Голосовые сообщения~~
- ~~Расширенная аналитика по поведению пользователей~~
- ~~Интеграция с внешними API каталогами~~

---

## 9. Критерии приемки

### 9.1. Функциональные критерии
- ✅ Бот отвечает на запросы за < 2 секунды
- ✅ Поиск находит релевантные товары
- ✅ Лиды создаются в Zoho CRM
- ✅ История диалогов сохраняется
- ✅ Админка позволяет загружать новый каталог
- ✅ Бот автоматически отвечает на языке пользователя

### 9.2. Нефункциональные критерии
- ✅ Система выдерживает 100 одновременных пользователей
- ✅ Доступность > 99.5% (проверка через UptimeRobot)
- ✅ Backup работает автоматически
- ✅ Документация покрывает все аспекты системы

---

## 10. Риски и ограничения

### 10.1. Технические риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Превышение лимитов LLM API | Средняя | Высокое | Кэширование, несколько провайдеров |
| Рост размера каталога > 100k | Низкая | Среднее | Оптимизация индексов, шардирование |
| DDoS атака на бота | Низкая | Высокое | Rate limiting, Cloudflare |

### 10.2. Ограничения
- Максимальный размер Excel файла: 100 MB
- Максимальная длина диалога: 1000 сообщений
- Максимальное время сессии веб-виджета: 24 часа
- Мультиязычность: автоматическая через LLM (без отдельных переводов интерфейса)

---

## 11. Бюджет проекта

### 11.1. Разовые затраты
| Статья | Стоимость |
|--------|-----------|
| Разработка MVP | По договоренности |
| Настройка инфраструктуры | Включено |
| **Итого** | **По договоренности** |

### 11.2. Ежемесячные затраты
| Статья | Стоимость |
|--------|-----------|
| VPS хостинг (Timeweb) | 990 ₽ |
| LLM API (OpenAI) | 300-500 ₽ |
| Домен (.ru) | 50 ₽ |
| SSL сертификат | Бесплатно (Let's Encrypt) |
| Мониторинг | Бесплатно |
| **Итого** | **~1,350-1,550 ₽/мес** |

---

## 12. Контакты и ответственные

| Роль | Ответственность | Контакт |
|------|----------------|---------|
| Заказчик | Требования, приемка | - |
| Разработчик | Реализация, поддержка | - |
| Менеджер | Работа с каталогом, тестирование | - |
| Администратор | Инфраструктура, мониторинг | - |

---

## Приложения

### Приложение А. Структура Excel файла каталога

```
| Колонка | Название | Тип | Обязательное | Описание |
|---------|----------|-----|--------------|----------|
| A | id | Integer | ✅ | Уникальный ID товара |
| B | name | String | ✅ | Наименование |
| C | description | String | ✅ | Описание |
| D | category 1 | String | ✅ | Категория 1-го уровня |
| E | category 2 | String | ✅ | Категория 2-го уровня |
| F | category 3 | String | ✅ | Категория 3-го уровня |
| G | article | String | ✅ | Артикул |
| H | photo_url | String | ❌ | URL фотографии |
| I | specifications | JSON | ❌ | Технические характеристики |
| J | keywords | String | ❌ | Ключевые слова через запятую |
```

### Приложение B. API endpoints

```
GET  /health              - Проверка состояния
GET  /api/stats           - Статистика системы
POST /api/search          - Поиск по каталогу
GET  /api/categories      - Список категорий
POST /api/lead            - Создание лида

GET  /admin/              - Админ-панель
POST /admin/catalog/upload - Загрузка каталога
POST /admin/prompts/update - Обновление промптов
POST /admin/deploy        - Деплой из GitHub
```

### Приложение C. Переменные окружения

```bash
# Обязательные
DATABASE_URL=            # PostgreSQL connection string
BOT_TOKEN=              # Telegram bot token
DEFAULT_LLM_PROVIDER=   # openai/yandex
OPENAI_API_KEY=         # Или другой LLM key

# CRM
ZOHO_TOKEN_ENDPOINT=

# Уведомления
MANAGER_EMAILS=         # email1@company.com,email2@company.com
MANAGER_TELEGRAM_CHAT_ID= # ID группы менеджеров
ALERT_TELEGRAM_CHAT_IDS=  # ID для критических алертов

# Опциональные
WEBHOOK_SECRET=         # Для защиты webhook
ADMIN_SECRET_KEY=       # Для админки
LOG_LEVEL=              # DEBUG/INFO/WARNING/ERROR
```

---

**Документ подготовлен:** Январь 2025  
**Версия архитектуры:** 1.5  
**Статус:** На согласовании с заказчиком

---

# Обновления v1.1 (Август 2025)

# Дополнения к техническому заданию v1.0

## 1. Дополнения к разделу 2.2 - Поиск и консультирование

### 2.2.1 Поиск по каталогу товаров - БЕЗ ИЗМЕНЕНИЙ
(Остается как есть)

### 2.2.2 Консультирование по услугам компании - ОБНОВЛЕНО
- **База знаний услуг**: хранится в PostgreSQL, редактируется через админ-панель
- **База знаний о компании**: отдельный DOCX/TXT файл
  - Содержит информацию о компании (название, местоположение, услуги, контакты, история)
  - Загружается через админ-панель отдельно от каталога товаров
  - Небольшой объем (несколько страниц) - загружается полностью в промпт LLM
  - Опциональная версионность для возможности отката
- Генерация ответов через LLM с учетом загруженного контекста

### 2.2.3 Классификация запросов - ОБНОВЛЕНО
Автоматическое определение типа запроса:
- `COMPANY_INFO` - вопросы о компании (как называется, где находится, какие услуги оказывает, контакты, история)
- `PRODUCT` - поиск конкретного товара из каталога
- `SERVICE` - вопрос об услугах компании (техническая поддержка, условия поставки, сервис)
- `GENERAL` - общий вопрос
- `CONTACT` - желание связаться с менеджером

## 2. Новый раздел 2.6 - Автоматическое управление лидами

### 2.6.1 Условия создания лидов
**Автоматическое создание лидов происходит при:**
- Таймаут неактивности пользователя > 30 минут (настраиваемо через админку)
- Явный запрос пользователя на связь с менеджером

**Минимальные требования для создания лида:**
- Имя пользователя (обязательно)
- Минимум один контакт:
  - Email ИЛИ
  - Телефон ИЛИ  
  - Telegram username (если пользователь согласился на общение через Telegram)

**Дополнительная информация:**
- Telegram username заполняется автоматически во всех лидах из Telegram бота
- В Zoho CRM используется специальное поле для хранения Telegram контактов

### 2.6.2 Проверка дубликатов в Zoho CRM
**Алгоритм проверки:**
1. Проверка запускается как только получен email или телефон от пользователя
2. Используется Zoho CRM Search API для поиска существующих лидов
3. Поиск ведется по полям: Email, Phone, Custom_Field_Telegram
4. Если найден дубликат - устанавливается флаг в локальной БД для избежания повторных проверок

**API запрос для проверки:**
```
GET https://www.zohoapis.com/crm/v3/Leads/search
criteria=(Email:equals:user@email.com) or (Phone:equals:79001234567) or (Custom_Field_Telegram:equals:@username)
```

### 2.6.3 Обработка найденных дубликатов
При обнаружении существующего лида:
- **Обновление данных**: дополнение пустых полей новой информацией из диалога
- **Создание заметки**: добавление Notes через Zoho Notes API с краткой саммари текущего диалога
- **Уведомления**: информирование менеджеров о повторном обращении клиента
- **Локальная отметка**: установка флага для избежания повторных проверок

**API для создания заметки:**
```
POST https://www.zohoapis.com/crm/v3/Leads/{lead_id}/Notes
{
  "data": [{
    "Note_Title": "Повторное обращение через Telegram бота",
    "Note_Content": "Краткая саммари диалога..."
  }]
}
```

## 3. Дополнения к разделу 3.1 - Админ-панель

### 3.1.1 Доступ и роли - дополнение таблицы

| Функция | Менеджер | Администратор |
|---------|----------|---------------|
| Управление файлом "О компании" | ✅ | ✅ |
| Настройка таймаута неактивности | ❌ | ✅ |
| Просмотр истории версий файла "О компании" | ✅ | ✅ |

### 3.1.2 Управление каталогом - БЕЗ ИЗМЕНЕНИЙ
(Остается как есть)

### 3.1.X Новый подраздел: Управление информацией о компании
- **Загрузка файла**: поддержка форматов DOCX, TXT, PDF
- **Предварительный просмотр**: отображение содержимого перед сохранением  
- **Версионность** (опционально):
  - Сохранение истории изменений
  - Возможность отката к предыдущей версии
  - Сравнение версий
- **Валидация**: проверка размера файла (макс. 2 MB)

### 3.1.Y Новый подраздел: Настройка автоматических лидов
- **Таймаут неактивности**: настройка времени (по умолчанию 30 минут)
- **Включение/отключение** автоматического создания лидов
- **Просмотр статистики** автоматически созданных лидов
- **Настройка полей** для передачи в Zoho CRM

## 4. Дополнения к разделу 4.1 - Архитектура системы

### 4.1.2 Структура данных - дополнения

**PostgreSQL** дополнительно хранит:
- Информацию о компании с версионностью
- Флаги проверки дубликатов лидов
- Системные настройки (таймауты, включение/отключение функций)
- Временные метки последней активности пользователей

**Новые требования к производительности:**
- Проверка дубликатов в Zoho CRM: < 1 секунды
- Обработка неактивных пользователей: каждые 10 минут (фоновая задача)
- Загрузка информации о компании в промпт: < 100мс

## 5. Дополнения к разделу 7.1 - Zoho CRM

### 7.1.1 Требования - дополнения
**Дополнительные API методы:**
- **Search API**: поиск существующих лидов по email/телефону/telegram
- **Notes API**: создание заметок к существующим лидам
- **Update Lead API**: обновление данных существующих лидов

**Дополнительные поля для передачи:**
- **Custom_Field_Telegram**: Telegram username
- **Lead_Source**: указание источника (всегда "Telegram Bot" или "Website Widget")
- **Auto_Created**: флаг автоматического создания (true/false)

### 7.1.2 Обработка ошибок - дополнения
**Специальная обработка для проверки дубликатов:**
- Таймаут запроса: 3 секунды
- При ошибке API - считаем что дубликатов нет, создаем новый лид
- Логирование всех случаев недоступности Search API

## 6. Дополнения к разделу 8 - Этапы реализации

### Фаза 1: MVP - дополнения
- [ ] Классификация запросов с типом COMPANY_INFO
- [ ] Загрузка и обработка файла "О компании"
- [ ] Базовая проверка дубликатов через Zoho Search API
- [ ] Автоматическое создание лидов при таймауте неактивности

### Фаза 2: Production Ready - дополнения  
- [ ] Управление файлом "О компании" через админку
- [ ] Версионность файла "О компании"
- [ ] Настройка таймаута неактивности через админку
- [ ] Обновление существующих лидов и создание заметок
- [ ] Фоновая задача мониторинга неактивных пользователей

### Фаза 3: Оптимизация - дополнения
- [ ] Оптимизация запросов к Zoho CRM API
- [ ] Расширенная аналитика по автоматически созданным лидам
- [ ] A/B тестирование таймаутов создания лидов

## 7. Дополнения к разделу 9 - Критерии приемки

### 9.1 Функциональные критерии - дополнения
- ✅ Бот правильно отвечает на вопросы о компании, используя загруженный файл
- ✅ Автоматически создаются лиды при неактивности > 30 минут
- ✅ Проверка дубликатов в Zoho CRM работает за < 1 секунды
- ✅ Существующие лиды обновляются новой информацией и заметками
- ✅ Менеджеры могут загружать и обновлять файл "О компании"
- ✅ Администраторы могут настраивать таймаут неактивности

### 9.2 Нефункциональные критерии - дополнения
- ✅ Фоновая задача обработки неактивных пользователей не влияет на производительность
- ✅ Проверка дубликатов не замедляет основной диалог
- ✅ Файл "О компании" корректно обрабатывается в форматах DOCX, TXT, PDF

## 8. Дополнения к разделу 10 - Риски и ограничения

### 10.2 Ограничения - дополнения
- Максимальный размер файла "О компании": 2 MB
- Максимальная частота проверки неактивных пользователей: каждые 5 минут
- Количество запросов к Zoho Search API: не более 100 в час (лимит API)
- Таймаут неактивности: минимум 10 минут, максимум 120 минут

## 9. Дополнения к Приложению A - Структура Excel файла каталога

**БЕЗ ИЗМЕНЕНИЙ** - каталог товаров остается прежним.

## 10. Новое Приложение D - Структура файла "О компании"

### D.1 Поддерживаемые форматы
- **DOCX**: Microsoft Word документ
- **TXT**: Простой текстовый файл (UTF-8)
- **PDF**: Portable Document Format (только текст, без изображений)

### D.2 Рекомендуемая структура содержимого
```
1. Название компании
2. Адрес и контактная информация
3. Основные направления деятельности
4. Виды услуг
5. Преимущества работы с компанией
6. История компании (кратко)
7. Сертификаты и лицензии
8. Режим работы
```

### D.3 Ограничения
- Максимальный размер: 2 MB
- Максимальная длина после извлечения текста: 10,000 символов
- Текст должен быть на том же языке, что и основное общение с клиентами

## 11. Новое Приложение E - API endpoints для управления лидами

```
# Проверка дубликатов (внутренний endpoint)
POST /api/internal/check-duplicate-lead
{
  "email": "user@example.com",
  "phone": "+79001234567", 
  "telegram": "@username"
}

# Создание лида с проверкой дубликатов
POST /api/internal/create-lead-safe
{
  "name": "Иван Петров",
  "email": "ivan@example.com",
  "phone": "+79001234567",
  "telegram": "@ivan_petrov",
  "question": "Интересуют болты М12",
  "auto_created": true
}

# Настройки автоматического создания лидов
GET /api/admin/lead-settings
PUT /api/admin/lead-settings
{
  "inactivity_timeout_minutes": 30,
  "auto_creation_enabled": true,
  "duplicate_check_enabled": true
}
```
