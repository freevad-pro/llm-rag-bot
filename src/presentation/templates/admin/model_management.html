{% extends "base.html" %}

{% block content %}
<div class="admin-layout">
    {% include "admin/partials/sidebar.html" %}
    <div class="sidebar-overlay d-md-none" onclick="toggleSidebar()"></div>
    
    <div class="main-wrapper">
        <div class="top-navbar d-flex justify-content-between flex-wrap align-items-center">
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-outline-light d-md-none me-2" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <h1 class="h2 mb-0">Управление моделью</h1>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Статус модели -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-cpu"></i>
                                Модель эмбеддингов
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Информация о модели -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Провайдер:</strong><br>
                                    <span class="text-muted">{{ model_provider }}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Модель:</strong><br>
                                    <span class="text-muted">{{ model_name }}</span>
                                </div>
                            </div>
                            
                            <!-- Статус -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Статус:</strong><br>
                                    <span id="modelStatus">
                                        {% if model_exists %}
                                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Загружена</span>
                                        {% else %}
                                            <span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Не загружена</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Размер:</strong><br>
                                    <span class="text-muted" id="modelSize">
                                        {% if model_size_mb %}
                                            {{ model_size_mb }} MB
                                        {% else %}
                                            —
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Прогресс загрузки -->
                            <div id="downloadProgress" style="display: {% if is_downloading %}block{% else %}none{% endif %};">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Прогресс загрузки:</span>
                                        <span id="progressPercent">0%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             id="progressBar"
                                             style="width: 0%">
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1" id="progressMessage"></small>
                                </div>
                            </div>
                            
                            <!-- Кнопки действий -->
                            <div class="btn-group" role="group" id="actionButtons">
                                {% if model_exists %}
                                    <button class="btn btn-warning" onclick="confirmDelete()" id="deleteBtn">
                                        <i class="bi bi-trash"></i>
                                        Удалить модель
                                    </button>
                                    <button class="btn btn-primary" onclick="downloadModel()" id="redownloadBtn">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Переза грузить
                                    </button>
                                {% else %}
                                    <button class="btn btn-success" onclick="downloadModel()" id="downloadBtn">
                                        <i class="bi bi-download"></i>
                                        Скачать модель
                                    </button>
                                {% endif %}
                                
                                <button class="btn btn-danger" onclick="cancelDownload()" id="cancelBtn" style="display: none;">
                                    <i class="bi bi-x-circle"></i>
                                    Отменить
                                </button>
                            </div>
                            
                            <!-- Предупреждение если модель не загружена -->
                            {% if not model_exists %}
                            <div class="alert alert-warning mt-3">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Внимание!</strong> Модель не загружена. 
                                Для работы индексации каталога необходимо сначала скачать модель эмбеддингов.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Боковая панель -->
                <div class="col-lg-4">
                    <!-- Информация о модели -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i>
                                О модели
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small">
                                <strong>{{ model_name }}</strong>
                            </p>
                            <p class="small text-muted">
                                Многоязычная модель для создания векторных представлений текста.
                                Поддерживает русский и английский языки.
                            </p>
                            
                            <h6 class="mt-3">Характеристики:</h6>
                            <ul class="list-unstyled small">
                                <li><i class="bi bi-check text-success"></i> Размер: ~350 MB</li>
                                <li><i class="bi bi-check text-success"></i> Offline работа</li>
                                <li><i class="bi bi-check text-success"></i> Без API ключей</li>
                                <li><i class="bi bi-check text-success"></i> Быстрая обработка</li>
                            </ul>
                            
                            <div class="alert alert-info mt-3">
                                <small>
                                    <i class="bi bi-lightbulb"></i>
                                    Модель скачивается один раз и кэшируется на сервере.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Быстрые действия -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-lightning"></i>
                                Быстрые действия
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/admin/catalog/upload" class="btn btn-outline-primary">
                                    <i class="bi bi-upload"></i>
                                    Загрузить каталог
                                </a>
                                <button class="btn btn-outline-info" onclick="checkStatus()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Обновить статус
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Внимание!</strong> Вы уверены что хотите удалить модель?
                </div>
                <p>После удаления модели:</p>
                <ul>
                    <li>Индексация каталога будет невозможна до повторной загрузки</li>
                    <li>Модель придётся скачать заново (~350 MB)</li>
                    <li>Кэш будет очищен</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash"></i>
                    Удалить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Toast контейнер -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="bi me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">Уведомление</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<script>
let statusUpdateInterval;

// Начать мониторинг при загрузке если идёт скачивание
document.addEventListener('DOMContentLoaded', function() {
    {% if is_downloading %}
    startStatusUpdates();
    {% endif %}
});

function startStatusUpdates() {
    statusUpdateInterval = setInterval(checkStatus, 2000); // Каждые 2 секунды
}

function stopStatusUpdates() {
    if (statusUpdateInterval) {
        clearInterval(statusUpdateInterval);
        statusUpdateInterval = null;
    }
}

async function checkStatus() {
    try {
        const response = await fetch('/admin/model/status');
        const data = await response.json();
        
        updateUI(data);
        
    } catch (error) {
        console.error('Ошибка проверки статуса:', error);
    }
}

function updateUI(data) {
    // Обновляем статус
    const statusEl = document.getElementById('modelStatus');
    if (data.model_exists) {
        statusEl.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Загружена</span>';
    } else {
        statusEl.innerHTML = '<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Не загружена</span>';
    }
    
    // Обновляем размер
    const sizeEl = document.getElementById('modelSize');
    sizeEl.textContent = data.model_size_mb ? `${data.model_size_mb} MB` : '—';
    
    // Обновляем прогресс
    const progressContainer = document.getElementById('downloadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressMessage = document.getElementById('progressMessage');
    
    if (data.is_downloading) {
        progressContainer.style.display = 'block';
        progressBar.style.width = `${data.download_progress}%`;
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-success', 'bg-danger');
        progressPercent.textContent = `${data.download_progress}%`;
        progressMessage.textContent = data.download_message;
        
        // Показываем кнопку отмены
        document.getElementById('cancelBtn').style.display = 'inline-block';
        document.getElementById('actionButtons').querySelectorAll('button:not(#cancelBtn)').forEach(btn => {
            btn.disabled = true;
        });
        
        if (!statusUpdateInterval) {
            startStatusUpdates();
        }
    } else {
        if (data.download_progress === 100 && !data.download_error) {
            // Загрузка завершена успешно
            progressContainer.style.display = 'block';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
            progressMessage.textContent = data.download_message;
            
            showToast('success', 'Успешно!', 'Модель загружена и готова к использованию');
            
            setTimeout(() => {
                location.reload(); // Перезагружаем страницу для обновления статуса
            }, 3000);
        } else if (data.download_error) {
            // Ошибка загрузки
            progressContainer.style.display = 'block';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressBar.style.width = `${data.download_progress || 0}%`;
            progressMessage.innerHTML = `<span class="text-danger">${data.download_message}</span>`;
            
            showToast('danger', 'Ошибка!', data.download_error);
        } else {
            progressContainer.style.display = 'none';
        }
        
        // Скрываем кнопку отмены
        document.getElementById('cancelBtn').style.display = 'none';
        document.getElementById('actionButtons').querySelectorAll('button:not(#cancelBtn)').forEach(btn => {
            btn.disabled = false;
        });
        
        stopStatusUpdates();
    }
}

async function downloadModel() {
    try {
        showToast('info', 'Запуск загрузки', 'Начинаю скачивание модели...');
        
        const response = await fetch('/admin/model/download', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('success', 'Загрузка начата', 'Следите за прогрессом ниже. Это займёт 5-10 минут.');
            
            // Показываем прогресс-бар сразу
            document.getElementById('downloadProgress').style.display = 'block';
            startStatusUpdates();
            checkStatus(); // Немедленная проверка
        } else {
            showToast('danger', 'Ошибка', data.message);
        }
        
    } catch (error) {
        console.error('Ошибка загрузки:', error);
        showToast('danger', 'Ошибка', 'Не удалось запустить загрузку');
    }
}

async function cancelDownload() {
    try {
        const response = await fetch('/admin/model/cancel', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('warning', 'Отменено', data.message);
            stopStatusUpdates();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('danger', 'Ошибка', data.message);
        }
        
    } catch (error) {
        console.error('Ошибка отмены:', error);
        showToast('danger', 'Ошибка', 'Не удалось отменить загрузку');
    }
}

function confirmDelete() {
    const modalEl = document.getElementById('deleteConfirmModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    modal.show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    try {
        const response = await fetch('/admin/model/', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        
        if (data.success) {
            showToast('success', 'Удалено', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('danger', 'Ошибка', data.message);
        }
        
    } catch (error) {
        console.error('Ошибка удаления:', error);
        showToast('danger', 'Ошибка', 'Не удалось удалить модель');
    }
});

function showToast(type, title, message) {
    const toast = document.getElementById('notificationToast');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    // Настраиваем иконку и цвета
    const icons = {
        'success': 'bi-check-circle-fill text-success',
        'danger': 'bi-exclamation-triangle-fill text-danger',
        'warning': 'bi-exclamation-circle-fill text-warning',
        'info': 'bi-info-circle-fill text-info'
    };
    
    toastIcon.className = `bi me-2 ${icons[type] || icons.info}`;
    toastTitle.textContent = title;
    toastBody.textContent = message;
    
    // Показываем Toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    bsToast.show();
}
</script>
{% endblock %}

