{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
.stats-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.stats-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
}

.stats-body {
    padding: 1rem;
}

.record-row {
    border-bottom: 1px solid #e9ecef;
    padding: 0.75rem 0;
}

.record-row:last-child {
    border-bottom: none;
}

.price-input {
    width: 100px;
    display: inline-block;
}

.currency-select {
    width: 80px;
    display: inline-block;
    margin-left: 0.5rem;
}

.update-price-btn {
    margin-left: 0.5rem;
}

.cost-display {
    font-weight: bold;
    color: #28a745;
}

.no-price {
    color: #6c757d;
    font-style: italic;
}

.current-month {
    border: 2px solid #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">{{ page_title }}</h1>
                    <small class="text-muted">Управление ценами и просмотр расходов на AI</small>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> Обновить
                    </button>
                </div>
            </div>

            <!-- Инструкция -->
            <div class="alert alert-info">
                <h6><i class="bi bi-info-circle"></i> Как работает контроль стоимости:</h6>
                <ul class="mb-0">
                    <li><strong>Без цен:</strong> Контролируются только токены</li>
                    <li><strong>С ценами:</strong> Контролируются токены И стоимость (берется максимальный процент)</li>
                    <li><strong>Установка цен:</strong> Введите цену за 1000 токенов и нажмите "Обновить"</li>
                    <li><strong>Валюты:</strong> USD и RUB (RUB автоматически конвертируется в USD по курсу ~95)</li>
                </ul>
            </div>

            <!-- Статистика по месяцам -->
            {% for month_key, month_data in monthly_stats %}
            <div class="stats-card {% if month_key == current_month %}current-month{% endif %}">
                <div class="stats-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar3"></i> 
                                {{ month_data.year }}-{{ "%02d"|format(month_data.month) }}
                                {% if month_key == current_month %}
                                <span class="badge bg-light text-dark ms-2">Текущий</span>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <div class="d-flex flex-column flex-md-row justify-content-md-end gap-3">
                                <div>
                                    <small>Токены:</small><br>
                                    <strong>{{ "{:,}".format(month_data.total_tokens) }}</strong>
                                </div>
                                <div>
                                    <small>Стоимость:</small><br>
                                    <strong class="cost-display">${{ "%.4f"|format(month_data.total_cost_usd) }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-body">
                    {% for record in month_data.records %}
                    <div class="record-row">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong>{{ record.provider|upper }}</strong><br>
                                <small class="text-muted">{{ record.model }}</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="badge bg-primary">
                                    {{ "{:,}".format(record.total_tokens) }} токенов
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <input 
                                        type="number" 
                                        step="0.00001" 
                                        class="form-control form-control-sm price-input" 
                                        id="price-{{ record.id }}"
                                        value="{{ record.price_per_1k_tokens or '' }}"
                                        placeholder="0.00015"
                                    >
                                    <select class="form-select form-select-sm currency-select" id="currency-{{ record.id }}">
                                        <option value="USD" {% if record.currency == 'USD' %}selected{% endif %}>USD</option>
                                        <option value="RUB" {% if record.currency == 'RUB' %}selected{% endif %}>RUB</option>
                                    </select>
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-outline-success update-price-btn"
                                        onclick="updatePrice({{ record.id }})"
                                    >
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                                <small class="text-muted">за 1K токенов</small>
                            </div>
                            <div class="col-md-3 text-end">
                                {% if record.price_per_1k_tokens %}
                                    {% set tokens_k = record.total_tokens / 1000 %}
                                    {% set price = record.price_per_1k_tokens|float %}
                                    {% set cost = tokens_k * price %}
                                    <div class="cost-display">
                                        {{ "%.4f"|format(cost) }} {{ record.currency }}
                                        {% if record.currency == 'RUB' %}
                                        <br><small>(≈ ${{ "%.4f"|format(cost / 95) }})</small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="no-price">Цена не задана</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}

            {% if not monthly_stats %}
            <div class="text-center py-5">
                <i class="bi bi-graph-up" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="text-muted mt-3">Нет данных</h4>
                <p class="text-muted">Статистика появится после первых AI запросов</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для результатов -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат операции</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Содержимое будет добавлено через JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function updatePrice(recordId) {
    const priceInput = document.getElementById(`price-${recordId}`);
    const currencySelect = document.getElementById(`currency-${recordId}`);
    const button = event.target.closest('button');
    
    const price = priceInput.value.trim();
    const currency = currencySelect.value;
    
    if (!price) {
        showModal('Ошибка', 'Введите цену за 1K токенов', 'error');
        return;
    }
    
    // Показываем индикатор загрузки
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('price', price);
        formData.append('currency', currency);
        
        const response = await fetch(`/admin/usage-statistics/update-price/${recordId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showModal('Успех', 'Цена обновлена успешно', 'success');
            // Обновляем страницу через 1 секунду
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showModal('Ошибка', result.error || 'Неизвестная ошибка', 'error');
        }
        
    } catch (error) {
        console.error('Ошибка при обновлении цены:', error);
        showModal('Ошибка', 'Ошибка сети или сервера', 'error');
    } finally {
        // Восстанавливаем кнопку
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

function refreshStats() {
    window.location.reload();
}

function showModal(title, message, type) {
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const modalTitle = document.querySelector('#resultModal .modal-title');
    const modalBody = document.getElementById('modalBody');
    
    modalTitle.textContent = title;
    
    const iconClass = type === 'success' ? 'bi-check-circle text-success' : 'bi-exclamation-triangle text-danger';
    modalBody.innerHTML = `
        <div class="text-center">
            <i class="${iconClass}" style="font-size: 2rem;"></i>
            <p class="mt-2">${message}</p>
        </div>
    `;
    
    modal.show();
}
</script>
{% endblock %}
