#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/test_and_deploy.sh
#
# –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env –∏–ª–∏ env.production:
#   PRODUCTION_SERVER - IP –∏–ª–∏ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞
#   PRODUCTION_USER - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SSH (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é root)
#   PRODUCTION_PORT - SSH –ø–æ—Ä—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22)

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞  
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[TEST&DEPLOY]${NC} $1"
}

success() {
    echo -e "${GREEN}‚úÖ${NC} $1"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è${NC} $1"
}

error() {
    echo -e "${RED}‚ùå${NC} $1"
    exit 1
}

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f ".env" ]; then
    log "üìù –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env"
    set -a
    source .env
    set +a
elif [ -f "env.production" ]; then
    log "üìù –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ env.production"
    set -a
    source env.production
    set +a
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
if [ -z "$PRODUCTION_SERVER" ]; then
    error "‚ùå PRODUCTION_SERVER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
    
–î–æ–±–∞–≤—å—Ç–µ –≤ .env –∏–ª–∏ env.production:
  PRODUCTION_SERVER=your-server-ip-or-domain
  PRODUCTION_USER=root  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é root
  PRODUCTION_PORT=22    # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 22"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
PRODUCTION_USER=${PRODUCTION_USER:-root}
PRODUCTION_PORT=${PRODUCTION_PORT:-22}

log "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–µ–ø–ª–æ—è..."
log "üì° –°–µ—Ä–≤–µ—Ä: $PRODUCTION_USER@$PRODUCTION_SERVER:$PRODUCTION_PORT"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
log "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Git..."
if ! git diff-index --quiet HEAD --; then
    warning "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git"
    echo "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    git status --porcelain
    echo
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏? (y/N): " confirm
    if [[ $confirm != [yY] ]]; then
        error "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ."
    fi
fi

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä—ã
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞..."

if command -v black &> /dev/null; then
    log "–ó–∞–ø—É—Å–∫–∞–µ–º black..."
    black --check src/ tests/ || error "Black –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: black src/ tests/"
else
    warning "Black –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
fi

if command -v isort &> /dev/null; then
    log "–ó–∞–ø—É—Å–∫–∞–µ–º isort..."
    isort --check-only src/ tests/ || error "isort –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: isort src/ tests/"
else
    warning "isort –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏–º–ø–æ—Ä—Ç–æ–≤"
fi

if command -v flake8 &> /dev/null; then
    log "–ó–∞–ø—É—Å–∫–∞–µ–º flake8..."
    flake8 src/ tests/ || error "flake8 –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞!"
else
    warning "flake8 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∏–ª—è"
fi

success "–ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã"

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã
log "‚ö° –ó–∞–ø—É—Å–∫–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã..."
if ! ./scripts/run_tests.sh fast; then
    error "–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
fi

success "–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã
log "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã..."
if ! ./scripts/run_tests.sh all; then
    warning "–ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
    echo
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ–ø–ª–æ–π –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è —Ç–µ—Å—Ç—ã? (y/N): " confirm
    if [[ $confirm != [yY] ]]; then
        error "–î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω –∏–∑-–∑–∞ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è —Ç–µ—Å—Ç–æ–≤"
    fi
    warning "–î–µ–ø–ª–æ–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è —Ç–µ—Å—Ç—ã!"
else
    success "–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
fi

# 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
log "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏..."
if ./scripts/run_tests.sh coverage; then
    success "–û—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ —Å–æ–∑–¥–∞–Ω –≤ htmlcov/"
else
    warning "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
fi

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
log "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ production —Å–µ—Ä–≤–µ—Ä—É..."
SSH_CMD="ssh -p $PRODUCTION_PORT $PRODUCTION_USER@$PRODUCTION_SERVER"
if ! $SSH_CMD "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'"; then
    error "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ production —Å–µ—Ä–≤–µ—Ä—É: $PRODUCTION_USER@$PRODUCTION_SERVER:$PRODUCTION_PORT"
fi

success "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —Ä–∞–±–æ—Ç–∞–µ—Ç"

# 7. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è  
echo
echo "=== –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –î–ï–ü–õ–û–Æ ==="
echo "‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ"
echo "‚úÖ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"
echo "‚úÖ –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo

read -p "üöÄ –ù–∞—á–∞—Ç—å –¥–µ–ø–ª–æ–π –Ω–∞ production? (y/N): " deploy_confirm
if [[ $deploy_confirm != [yY] ]]; then
    warning "–î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

# 8. –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
log "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ production..."

# –ö–æ–º–º–∏—Ç–∏–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
if ! git diff-index --quiet HEAD --; then
    log "üìù –ö–æ–º–º–∏—Ç–∏–º —Ç–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    COMMIT_MSG="deploy: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º $(date +'%Y-%m-%d %H:%M:%S')"
    git add .
    git commit -m "$COMMIT_MSG"
    success "–ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã"
fi

# –ü—É—à–∏–º –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
log "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
git push origin main
success "–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
log "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
$SSH_CMD "bot update-stash"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è..."
if $SSH_CMD "bot health"; then
    success "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ production"
else
    error "–ü—Ä–æ–±–ª–µ–º—ã –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: $SSH_CMD 'bot status'"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
echo
echo "=== –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù ==="
echo "üìÖ –í—Ä–µ–º—è: $(date)"
echo "üåê URL: http://$PRODUCTION_SERVER:8000"
echo "üîç Health: http://$PRODUCTION_SERVER:8000/health"
echo "üìä –°—Ç–∞—Ç—É—Å: $SSH_CMD 'bot status'"
echo
success "üéâ –í—Å–µ –≥–æ—Ç–æ–≤–æ! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ production"
